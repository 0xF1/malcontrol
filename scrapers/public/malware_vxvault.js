var scraper = require('./../scraper');
var _savemalware = require('../../commons/save_malw');
var _base_searching_url = "http://vxvault.siri-urz.net/ViriList.php?s=1&m=";

var _local_cache = {};

//VXVAULT
exports.goScraper = function(){

  _savemalware.firstTimeRunningMalware("vxvault.siri-urz.net",function(firstime){

    var url;
    if (firstime){
      url = _base_searching_url + "500"
      console.log("[+] First time you are scraping vxvault.siri-urz.net");
    } else {
      console.log("[+] Not the first time you are scraping vxvault.siri-urz.net!");
      url = _base_searching_url + "30";
    }
    try{

      var curDate = new Date();
      var startYear = curDate.getFullYear();

      return scraper(url, function(err, jQuery) {
        if (err) {return console.log("[-] Error happening in malc0de: " + err);}
        console.log("[+] Querying vxvault");

        var i = 0;
        return jQuery('tr').each(function() {
          //super specific to website !
          i++;
          if ( i<=1 )
            return true; //continue

          // Assuming ordered by date
          var content = jQuery(this);
          if (undefined !== content && null !== content){

            var linkToReport = undefined;
            var link = content.find('a[href*="ViriFiche.php"]').attr('href');
            if(undefined !== link && null !== link){
              linkToReport =  "http://vxvault.siri-urz.net/" + link; 
              console.log("[+] Link To Report found: " + linkToReport);
              if (_local_cache[link] ){
                console.log("[-] Already Analyed !");
                return;
              } else {
                _local_cache[link] = true;
              }
            }

            var timestamp = content.find("td").eq(0).text();
            var md = /^\s*(\d{1,2})-(\d{1,2})\s*$/.exec(timestamp);
            if (md === null) {
              console.error("[+] <vxvault.siri-urz.net> Time Stamp changed: " + timestamp);
            }
            if (parseInt(md[1]) === 0 || parseInt(md[2]) === 0) {
              timestamp = new Date(0).toISOString();
            } else {
              var d1 = new Date(startYear + '-' + md[1] + '-' + md[2] + ' UTC');
              var d2 = new Date((startYear - 1) + '-' + md[1] + '-' + md[2] + ' UTC');
              if (Math.abs(d1 - curDate) < Math.abs(d2 - curDate)) {
                curDate = d1;
              } else {
                curDate = d2;
              }
              startYear = curDate.getFullYear();
              timestamp = curDate.toISOString();
            }
            console.log("[+] <vxvault.siri-urz.net> Time Stamp found: " + timestamp);

            var md5 = content.find("td").eq(2).text();
            console.log("[+] <vxvault.siri-urz.net> MD5 found: " + md5);

            var ip = content.find("td").eq(3).text();
            console.log("[+] <vxvault.siri-urz.net> IP found: " + ip);

            var compositscore = "100/100"; 

            var name = content.find("td").eq(1).text();
            console.log("[+] <vxvault.siri-urz.net> Name found: " + name);

            var dsc = "Download: " + content.find('a[href*="http://vxvault.siri-urz.net/files/"]').attr('href');
            console.log("[+] <vxvault.siri-urz.net> Desc found: " + dsc);

            _savemalware.saveMalwareToDB(linkToReport, timestamp, ip, compositscore, "vxvault.siri-urz.net", dsc, md5, name);
            return true;
          }//not nulls
        });//foreach element in the table of the scraped source
      },{'reqPerSec': 0.2});//scraper
    } catch(ex){return console.log("[-] Error in scraping malrw " + ex);}
  });//firsttime
};//goScraper

