var scraper                 = require('./scraper');
var _savemalware            = require('../commons/save_malw');
var _base_searching_url     = "http://www.malwareblacklist.com/showAllMalwareURL.php?userName=Guest&sessionID=&downloadOption=0&pageNo=";
var _followingparams        = "&totalPageno=20";

var _local_cache = {};

//URLQUERY
exports.goScraper = function(){

  _savemalware.firstTimeRunningMalware("malwareblacklist.com",function(firstime){

    var uris = [];
    if (firstime){
      for(var i=1; i<5000; i++){
        uris[i-1] = _base_searching_url + i + _followingparams;
      }
      console.log("[+] First time you are scraping malwareblacklist.com");
      console.log("[+] Building DB =========================================");
      console.log("[+] Will query: " + uris.length *50 + " This will get a lot of resources and time !");
      console.log("[+] Building DB =========================================");
    } else {
      console.log("[+] Not the first time you are scraping malwwareblacklist.com!");
      uris[0] = _base_searching_url + "1";
    }
    try{
      console.log(uris[0]);
      return scraper(uris, function(err, jQuery) {
        if (err) {return console.log("[-] Error happening in malwareblacklist.com: " + err);}
        console.log("[+] Querying malwareblacklist");

        var i = 0;
        return jQuery('.table tr').each(function() {
          //super specific to website !
          i++;
          if ( i<=1 )
            return true; //continue

          var content = jQuery(this);
          if (undefined !== content && null !== content){

            var linkToReport = "NA";
            //var link = content.find('a[href*="virustotal"]').attr('href');
            //if(undefined !== link && null !== link){
              //linkToReport =  link; 
              //console.log("[+] Link To Report found: " + linkToReport);
              //if (_local_cache[link] ){
                //console.log("[-] Already Analyed !");
                //return;
              //} else {
                //_local_cache[link] = true;
              //}
            //}

            var timestamp  = content.find("td").eq(0).text();
            console.log("[+] <malwareblacklist.com> Time Stamp found: " + timestamp);

            var md5 = "NA";

            var ip = content.find("td").eq(3).text();
            console.log("[+] <malwareblacklist.com> IP found: " + ip);

            var compositscore = "100/100"; 

            var name = content.find("td").eq(1).text();
            console.log("[+] <malwareblacklist.com> Name found: " + name);

            var dsc = content.find("td").eq(5).text();
            desc = desc + "Submitted by(" + content.find("td").eq(8).text() + ")";
            desc = desc + "Registar by (" + content.find("td").eq(2).text() + ")";;
            console.log("[+] <malwareblacklist.com> Desc found: " + dsc);

            return _savemalware.saveMalwareToDB(linkToReport, timestamp, ip, compositscore, "malwareblacklist.com", dsc, md5, name); 
          }//not nulls
        });//foreach element in the table of the scraped source
      },{'reqPerSec': 0.2});//scraper
    } catch(ex){return console.log("[-] Error in scraping malrw " + ex);}
  });

};//goScraper
